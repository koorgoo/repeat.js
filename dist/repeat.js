(function(){"use strict";var exports={};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var exportAll=exports.exportAll=function exportAll(){return{Repeat:Repeat,Scheduler:Scheduler,Action:Action,Permission:Permission}};var Repeat=function(){function Repeat(options){_classCallCheck(this,Repeat);options=options||{};if(typeof options.action!=="function"){throw new Error("Action must be a function.")}var posts=[];if(options.post){if(typeof options.post==="function"){posts.push(options.post)}else if(typeof options.post==="array"){options.post.forEach(function(post){posts.push(post)})}}var timeout;if(typeof options.timeout==="function"){timeout=options.timeout}else if(typeof options.timeout==="number"){timeout=function timeout(){return options.timeout}}else{throw new Error("Timeout must be a number of a function.")}var permit;if(typeof options.permit==="function"){permit=options.permit}else{permit=function permit(){return true}}this.scheduler=new Scheduler({action:options.action,posts:posts,timeout:timeout,permit:permit})}_createClass(Repeat,[{key:"run",value:function run(){this.scheduler.run()}},{key:"call",value:function call(){this.scheduler.callAction()}},{key:"stop",value:function stop(){this.scheduler.stop()}}]);return Repeat}();var Scheduler=function(){function Scheduler(options){_classCallCheck(this,Scheduler);this.action=options.action;this.posts=options.posts;this.timeout=options.timeout;this.permit=options.permit}_createClass(Scheduler,[{key:"run",value:function run(){var action=this._createAction();action.call()}},{key:"callAction",value:function callAction(){this.stop();this.run()}},{key:"stop",value:function stop(){if(this.scheduled){clearTimeout(this.scheduled);this.scheduled=null}if(this.permission){this.permission.deny();this.permission=null}}},{key:"_createAction",value:function _createAction(){var scheduler=this;var perm=this.permission=new Permission(this.permit);var action=new Action(perm.wrap(this.action));this.posts.forEach(function(post){return action.addPost(perm.wrap(post))});action.addPost(perm.wrap(this._createSchedulePost(action)),true);this.__onActionInTest(action);return action}},{key:"_createSchedulePost",value:function _createSchedulePost(action){var scheduler=this;var call=action.call.bind(action);return function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}var timeout=scheduler.timeout.apply(null,args);scheduler.scheduled=setTimeout(call,timeout)}}},{key:"__onActionInTest",value:function __onActionInTest(action){}}]);return Scheduler}();var Action=function(){function Action(action){_classCallCheck(this,Action);this.action=action;this.posts={success:[],always:[]}}_createClass(Action,[{key:"addPost",value:function addPost(post,callAlways){if(callAlways){this.posts.always.push(post)}else{this.posts.success.push(post)}}},{key:"call",value:function call(){var value;try{value=this.action()}catch(e){}if(isPromise(value)){this.posts.success.forEach(function(post){return value.then(post)});this.posts.always.forEach(function(post){return value.then(post,post)})}else{this.posts.success.forEach(function(post){return post(value)});this.posts.always.forEach(function(post){return post(value)})}return value}}]);return Action}();function isPromise(value){return value&&typeof value.then==="function"}var Permission=function(){function Permission(permit){_classCallCheck(this,Permission);this.permit=permit||function(){return true};this.granted=this.granted.bind(this)}_createClass(Permission,[{key:"granted",value:function granted(){if(this.denied){return false}return this.permit()}},{key:"deny",value:function deny(){this.denied=true}},{key:"wrap",value:function wrap(fn){var granted=this.granted;return function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2]}if(granted()){return fn.apply(null,args)}}}}]);return Permission}();if(typeof window==="object"){window.Repeat=Repeat}else if(module&&module.exports){module.exports=Repeat}})();