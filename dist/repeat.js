(function(){"use strict";var exports={};var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var exportAll=exports.exportAll=function exportAll(){return{Repeat:Repeat,Scheduler:Scheduler,Action:Action,Permission:Permission,toFunctionsArray:toFunctionsArray,callSafely:callSafely}};var Repeat=function(){function Repeat(options){_classCallCheck(this,Repeat);options=options||{};if(typeof options.action!=="function"){throw new Error("Action must be a function.")}var done=toFunctionsArray(options.done);var fail=toFunctionsArray(options.fail);var always=toFunctionsArray(options.always);var timeout;if(typeof options.timeout==="function"){timeout=options.timeout}else if(typeof options.timeout==="number"){timeout=function timeout(){return options.timeout}}else{throw new Error("Timeout must be a number of a function.")}var permit;if(typeof options.permit==="function"){permit=options.permit}else{permit=function permit(){return true}}this.scheduler=new Scheduler({action:options.action,done:done,fail:fail,always:always,timeout:timeout,permit:permit})}_createClass(Repeat,[{key:"run",value:function run(){this.scheduler.run()}},{key:"call",value:function call(){this.scheduler.callAction()}},{key:"stop",value:function stop(){this.scheduler.stop()}}]);return Repeat}();var Scheduler=function(){function Scheduler(options){_classCallCheck(this,Scheduler);this.action=options.action;this.done=options.done;this.fail=options.fail;this.always=options.always;this.timeout=options.timeout;this.permit=options.permit}_createClass(Scheduler,[{key:"run",value:function run(){var action=this._createAction();action.call()}},{key:"callAction",value:function callAction(){this.stop();this.run()}},{key:"stop",value:function stop(){if(this.scheduled){clearTimeout(this.scheduled);this.scheduled=null}if(this.permission){this.permission.deny();this.permission=null}}},{key:"_createAction",value:function _createAction(){var perm=this.permission=new Permission(this.permit);var action=new Action(perm.wrap(this.action),this.done.map(perm.wrap),this.fail.map(perm.wrap));action.always=this.always.map(perm.wrap).concat([perm.wrap(this._createScheduleCallback(action))]);this.__onActionInTest(action);return action}},{key:"_createScheduleCallback",value:function _createScheduleCallback(action){var scheduler=this;var call=action.call.bind(action);return function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}var timeout=scheduler.timeout.apply(null,args);scheduler.scheduled=setTimeout(call,timeout)}}},{key:"__onActionInTest",value:function __onActionInTest(action){}}]);return Scheduler}();var Action=function(){function Action(action,done,fail,always){_classCallCheck(this,Action);this.action=action;this.done=done;this.fail=fail;this.always=always}_createClass(Action,[{key:"call",value:function call(){var _callSafely=callSafely(this.action);var _callSafely2=_slicedToArray(_callSafely,2);var value=_callSafely2[0];var error=_callSafely2[1];if(isPromise(value)){this.done.forEach(function(cb){return value.then(cb)});this.fail.forEach(function(cb){return value.then(null,cb)});this.always.forEach(function(cb){return value.then(cb,cb)})}else{var array=!error?this.done:this.fail;array.forEach(function(cb){return callSafely(cb,value,error)});this.always.forEach(function(cb){return callSafely(cb,value,error)})}return[value,error]}}]);return Action}();var Permission=function(){function Permission(permit){_classCallCheck(this,Permission);this.permit=permit||function(){return true};this.granted=this.granted.bind(this);this.wrap=this.wrap.bind(this)}_createClass(Permission,[{key:"granted",value:function granted(){if(this.denied){return false}return this.permit()}},{key:"deny",value:function deny(){this.denied=true}},{key:"wrap",value:function wrap(fn){var granted=this.granted;return function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2]}if(granted()){return fn.apply(null,args)}}}}]);return Permission}();function isPromise(value){return value&&typeof value.then==="function"}function toFunctionsArray(arr){if(arr===null||arr===undefined){arr=[]}else if(!(arr instanceof Array)){arr=[arr]}for(var i=0;i<arr.length;i++){if(typeof arr[i]!=="function"){throw new Error("Functions are requried.")}}return arr}function callSafely(fn){var result;var error;try{for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){args[_key3-1]=arguments[_key3]}result=fn.apply(null,args)}catch(e){error=e}return[result,error]}if(typeof window==="object"){window.Repeat=Repeat}else if(module&&module.exports){module.exports=Repeat}})();